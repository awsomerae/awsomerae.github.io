<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이치엘비셀 관리시스템</title>
    <link rel="icon" href="http://192.168.0.254:5000/sharing/Ign4YpvVO" type="image/png">
    <style>
        /* project newgate , prod RAE */

        /* === GitHub Style Redesign === */

        /* 1. 기본 및 폰트 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            padding: 0;
            background-color: #f6f8fa; /* GitHub 페이지 배경색 */
            color: #24292e; /* 기본 텍스트 색상 */
            font-size: 14px; /* 기본 폰트 크기 조정 */
        }

        *, input, select, button, textarea, table, th, td {
            font-size: inherit; /* body의 폰트 크기 상속 */
            box-sizing: border-box; /* 모든 요소에 box-sizing 적용 */
        }

        h2, h3 { /* 제목 스타일 */
            font-weight: 600;
            color: #24292e;
        }
        h2 { font-size: 1.75em; margin-bottom: 16px; }
        h3 { font-size: 1.25em; margin-bottom: 12px; }


        /* 2. 컨테이너 */
        .container {
            max-width: none;
            width: 90vw;
            margin-left: 5vw;
            margin-right: 5vw;
            background-color: #ffffff;
            padding: 24px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
        }

        .page { display: none; } /* 페이지 기본 숨김 */

        /* 3. 헤더 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 16px;
            border-bottom: 1px solid #e1e4e8;
            margin-bottom: 24px;
            flex-wrap: wrap; /* 헤더 내용이 많아지면 줄바꿈 */
        }
        .header h2 {
            margin-top: 0; /* h2의 기본 margin 제거 */
            margin-bottom: 4px;
        }
        .header .user-info {
            font-size: 0.85em;
            color: #586069;
            margin-top: 4px;
        }
        .header .buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap; /* 버튼 줄바꿈 */
            justify-content: flex-end;
        }

        /* 4. 버튼 스타일 */
        .header .buttons button,
        .popup-content .button-group button,
        .checkin-entry-form .save-button,
        .dashboard-link .nav-button,
        .save-button-small, .delete-button-small {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid rgba(27,31,35,0.15);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            line-height: 20px;
            white-space: nowrap; /* 버튼 텍스트 줄바꿈 방지 */
        }

        .header .buttons .nav-button, .dashboard-link .nav-button {
            background-color: #fafbfc;
            color: #24292e;
            border-color: rgba(27,31,35,0.15);
        }
        .header .buttons .nav-button:hover, .dashboard-link .nav-button:hover {
            background-color: #f3f4f6;
            border-color: rgba(27,31,35,0.2);
        }

        .header .buttons .action-button {
            background-color: #2ea44f;
            color: white;
            border-color: rgba(27,31,35,0.15);
        }
        .header .buttons .action-button:hover {
            background-color: #2c974b;
        }

        .header .buttons .refresh-button {
            background-color: #0366d6;
            color: white;
            border-color: rgba(27,31,35,0.15);
        }
        .header .buttons .refresh-button:hover {
            background-color: #005cc5;
        }

        .header .buttons .delete-button,
        .popup-content .button-group .delete-button {
            background-color: #d73a49;
            color: white;
            border-color: rgba(27,31,35,0.15);
        }
        .header .buttons .delete-button:hover,
        .popup-content .button-group .delete-button:hover {
            background-color: #cb2431;
        }

        .popup-content .button-group .save-button {
            background-color: #2ea44f; color: white; border-color: rgba(27,31,35,0.15);
        }
        .popup-content .button-group .save-button:hover { background-color: #2c974b; }

        .popup-content .button-group .cancel-button {
            background-color: #fafbfc; color: #d73a49; border-color: rgba(27,31,35,0.15);
        }
        .popup-content .button-group .cancel-button:hover { background-color: #f3f4f6; }


        /* 5. 테이블 스타일 */
        .data-section {
            min-height: 300px; /* 최소 높이 설정, 내용 없을 때 대비 */
            height: calc(100vh - 260px); /* 헤더, 패딩, 마진 등을 고려한 높이 */
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #e1e4e8;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background-color: #f6f8fa;
            font-weight: 600;
            padding-top: 12px;
            padding-bottom: 12px;
            position: sticky; /* 테이블 헤더 고정 */
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #f6f8fa;
        }
        tr:hover {
            background-color: #f1f8ff;
            cursor: pointer;
        }
        td.numeric { text-align: right; }

        /* 6. 팝업 스타일 */
        .popup-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* GitHub 스타일 배경 어둡게 */
            justify-content: center; align-items: center; z-index: 1000;
        }
        .popup-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 6px;
            /* border: 1px solid #d1d5da; */ /* 오버레이가 이미 테두리 역할 */
            box-shadow: 0 8px 24px rgba(149,157,165,0.2); /* GitHub 스타일의 그림자 */
            max-width: 700px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .popup-content h3 {
            margin-top: 0;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 12px;
            font-size: 1.4em;
        }
        .popup-content form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .popup-content label {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 6px;
            display: block;
        }
        .popup-content input, .popup-content select, .popup-content textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            background-color: #f6f8fa;
        }
        .popup-content input:focus, .popup-content select:focus, .popup-content textarea:focus {
            border-color: #0366d6;
            background-color: #fff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(3,102,214,0.3);
        }
        .popup-content .button-group {
            grid-column: 1 / -1;
            text-align: right;
            margin-top: 15px;
            display: flex; /* 버튼 그룹 정렬 */
            justify-content: flex-end;
            gap: 8px;
        }
        .popup-instructions {
            grid-column: 1 / -1;
            font-size: 0.9em;
            color: #586069;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e4e8;
        }


        /* 7. 로그인 페이지 */
        #loginPage {
            display: none; /* 초기 none, JS로 flex 제어 */
            flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background-color: #f6f8fa;
            padding: 20px;
        }
        #loginPage .login-box {
            background-color: #fff;
            padding: 32px;
            border-radius: 6px;
            border: 1px solid #d1d5da;
            text-align: center;
            width: 100%;
            max-width: 360px;
        }
        #loginPage h2 {
            font-size: 1.75em;
            margin-bottom: 24px;
            margin-top: 0;
        }
        #loginPage input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            background-color: #f6f8fa;
            margin-bottom: 16px;
        }
        #loginPage input:focus {
            border-color: #0366d6;
            background-color: #fff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(3,102,214,0.3);
        }
        #loginPage button {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            border: 1px solid rgba(27,31,35,0.15);
        }
        #loginPage .login-button {
            background-color: #2ea44f; color: white;
        }
        #loginPage .login-button:hover { background-color: #2c974b; }
        #loginPage .new-account-button {
            background-color: #0366d6; color: white; margin-top: 12px;
        }
        #loginPage .new-account-button:hover { background-color: #005cc5; }


        /* 증빙 업로드 버튼 그룹 스타일 조정 */
        .upload-button-group {
            display: flex;
            align-items: center; /* 버튼과 인풋 수직 정렬 */
            gap: 8px;
        }
        .upload-button-group input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0 !important;
        }
        .upload-button-group button {
            padding: 8px 12px;
            background-color: #0366d6; color: white;
            font-size: 13px;
            height: 38px; /* 인풋 높이와 비슷하게 */
            flex-shrink: 0;
        }
        .upload-button-group button:hover { background-color: #005cc5; }


        /* 관리자 페이지 선택된 행 */
        #adminPage .data-section table tr.selected,
        #accountTable tbody tr.selected { /* ID 직접 지정 */
            background-color: #f1f8ff !important; /* !important로 우선순위 */
            /* border-left: 3px solid #0366d6; */ /* 선택 표시 방식 변경 가능 */
        }
        #adminPage .data-section table tr.selected td,
        #accountTable tbody tr.selected td {
            font-weight: 500;
        }
        /* 계정 테이블 컬럼 너비 */
        #accountTable { table-layout: fixed; width: 100%; }
        #accountTable th:nth-child(1), #accountTable td:nth-child(1) { width: 120px; } /* ID */
        #accountTable th:nth-child(2), #accountTable td:nth-child(2) { width: 120px; } /* password */
        #accountTable th:nth-child(3), #accountTable td:nth-child(3) { width: 100px; } /* 소속 */
        #accountTable th:nth-child(4), #accountTable td:nth-child(4) { width: 100px; } /* 성명 */
        #accountTable th:nth-child(5), #accountTable td:nth-child(5) { width: 100px; } /* 직급 */


        /* Check-in Page specific styles */
        .checkin-entry-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
        }
        .checkin-entry-form h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .checkin-entry-form .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .checkin-entry-form .form-group.full-width {
            grid-column: 1 / -1;
        }
        .checkin-entry-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .checkin-entry-form input[type="text"],
        .checkin-entry-form input[type="date"],
        .checkin-entry-form select,
        .checkin-entry-form textarea {
            background-color: #fff; /* 입력 필드 흰색 배경 */
            border: 1px solid #d1d5da;
        }
        .checkin-entry-form textarea { resize: vertical; }

        .delete-button-small {
            padding: 4px 8px;
            font-size: 12px;
            background-color: transparent;
            color: #d73a49;
            border: 1px solid transparent;
        }
        .delete-button-small:hover {
            background-color: #fff5f5;
            border-color: #d73a49;
            color: #cb2431;
        }

        #checkInTable td { max-width: 250px; }
        #checkInTable td:nth-child(4), #checkInTable th:nth-child(4), /* 내용 */
        #checkInTable td:nth-child(6), #checkInTable th:nth-child(6) { /* 피드백 */
            white-space: normal;
            word-break: break-word;
            min-width: 150px;
        }

        /* Feedback Page specific styles */
        #evalUserListTable tbody tr:hover { background-color: #f1f8ff; }
        .feedback-content-cell {
            max-width: 300px;
            white-space: normal !important;
            word-break: break-word;
        }
        #userCheckInsTableForFeedback textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            background-color: #f6f8fa;
        }
        #userCheckInsTableForFeedback textarea:focus {
            background-color: #fff;
            border-color: #0366d6;
        }
        .save-button-small {
            padding: 5px 10px;
            font-size: 0.9em;
            background-color: #2ea44f;
            color: white;
        }
        .save-button-small:hover { background-color: #2c974b; }

        /* Dashboard Page specific styles */
        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-row {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .dashboard-section {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e1e4e8;
            flex: 1 1 0;
            min-width: 0;
        }
        .dashboard-section h3 {
            margin-top: 0;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 10px;
            font-size: 1.2em;
        }
        .dashboard-section table {
            font-size: 0.9em;
            width: 100%;
            table-layout: fixed;
        }
        .dashboard-link {
            margin-top: 15px;
            text-align: right;
        }
        .dashboard-link .nav-button {
            font-size: 0.9em;
            padding: 6px 12px;
        }
        #dashboardCheckInTable th:nth-child(1), #dashboardCheckInTable td:nth-child(1) { width: 5%; }
        #dashboardCheckInTable th:nth-child(2), #dashboardCheckInTable td:nth-child(2) { width: 45%; }
        #dashboardCheckInTable th:nth-child(3), #dashboardCheckInTable td:nth-child(3) { width: 5%; }
        #dashboardCheckInTable th:nth-child(4), #dashboardCheckInTable td:nth-child(4) { width: 45%; }
        #dashboardPurchaseTable th:nth-child(1), #dashboardPurchaseTable td:nth-child(1) { width: 20%; }
        #dashboardPurchaseTable th:nth-child(2), #dashboardPurchaseTable td:nth-child(2) { width: 50%; }
        #dashboardPurchaseTable th:nth-child(3), #dashboardPurchaseTable td:nth-child(3) { width: 30%; }
        #dashboardExpenseTable th:nth-child(1), #dashboardExpenseTable td:nth-child(1) { width: 20%; }
        #dashboardExpenseTable th:nth-child(2), #dashboardExpenseTable td:nth-child(2) { width: 50%; }
        #dashboardExpenseTable th:nth-child(3), #dashboardExpenseTable td:nth-child(3) { width: 30%; }
    </style>
</head>
<body>

    <script>
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyk5qTvZzF1cqNveAFMQ8f31v8S89PgaV9s504v7XsS3LasBeuNNr8jf4oSzKGdF0zP/exec'; // <-- ⭐ 실제 웹 앱 URL로 교체하세요 ⭐
        let loggedInUser = null;
        let currentEditingRowIndex = null;
        let selectedAccountId = null; // 관리자 페이지에서 선택된 계정 ID (단일 클릭 시)
        let currentEditingAccountData = null;

        const ACCOUNT_HEADERS = ['ID', 'password', '소속', '성명', '직급'];
        const PURCHASE_HEADERS = ['담당자', '구매구분', '프로젝트', '국책과제여부', '구매품의번호', '구매품의명', '품의서링크', '구매처', '물품명', '단가', '수량', '공급가', '부가세', '합계', '세금계산서일자', '비고', '증빙'];
        const EXPENSE_HEADERS = ['담당자', '일자', '비목', '사용처', '적요', '공급가', '부가세', '합계', '비고' , '증빙'];
        const CHECKIN_HEADERS = ['작성자ID', '일자', '구분', '내용', '상태', '피드백'];

        let usersToEvaluateGlobal = [];
        let selectedUserForFeedbackId = null;
        // let checkInToDeleteRowIndex = null; // 삭제됨
        // let checkInToDeleteEntryId = null; // 삭제됨

        function formatNumberWithCommas(number) {
            if (number === null || number === undefined || number === '' || isNaN(parseFloat(String(number).replace(/,/g, '')))) {
                return '';
            }
            try {
                return parseFloat(String(number).replace(/,/g, '')).toLocaleString('en-US');
            } catch (e) {
                console.error("Error formatting number:", number, e);
                return number;
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            const pageElement = document.getElementById(pageId);

            if (pageId === 'loginPage') {
                pageElement.style.display = 'flex';
            } else {
                pageElement.style.display = 'block';
            }

            if (loggedInUser) { // 로그인된 상태에서만 사용자 정보 업데이트 및 데이터 로드
                updateUserInfo(); // 네비게이션 버튼 상태 등 업데이트

                if (pageId === 'purchasePage') loadPurchaseData();
                else if (pageId === 'expensePage') loadExpenseData();
                else if (pageId === 'adminPage' && loggedInUser.isAdmin) loadAccountData();
                else if (pageId === 'checkInPage') {
                    loadCheckInData();
                    document.getElementById('checkInEntryAuthor').value = loggedInUser.name;
                    document.getElementById('checkInEntryDate').valueAsDate = new Date();
                    clearCheckInInputs(false);
                } else if (pageId === 'feedbackPage' && (loggedInUser.isEvaluator || loggedInUser.isAdmin)) {
                    loadUsersToEvaluate();
                    document.getElementById('userCheckInsForFeedbackSection').style.display = 'none';
                } else if (pageId === 'dashboardPage') {
                    loadDashboardData();
                }
            }
        }
        
        function updateUserInfo() {
            if (loggedInUser) {
                const userInfoSpans = document.querySelectorAll('.user-info span');
                const userInfoText = `사용자: ${loggedInUser.affiliation || '소속없음'} ${loggedInUser.name} ${loggedInUser.position || '직급없음'}`;
                userInfoSpans.forEach(span => {
                    span.textContent = userInfoText;
                });

                const adminNavButtons = document.querySelectorAll('[id^="navButtonAdminPage"]');
                adminNavButtons.forEach(button => {
                    button.style.display = loggedInUser.isAdmin ? 'inline-block' : 'none';
                });

                const feedbackNavButtons = document.querySelectorAll('[id^="navButtonFeedbackPage"]');
                // loggedInUser.isEvaluator는 로그인 응답에 포함되어야 합니다.
                // isAdmin도 isEvaluator 역할을 할 수 있도록 로직 추가
                const canShowFeedbackButton = loggedInUser.isAdmin || loggedInUser.isEvaluator;
                feedbackNavButtons.forEach(button => {
                    button.style.display = canShowFeedbackButton ? 'inline-block' : 'none';
                });

            } else { // 로그아웃 시 모든 관련 버튼 숨김
                document.querySelectorAll('.user-info span').forEach(s => s.textContent = '');
                document.querySelectorAll('[id^="navButtonAdminPage"]').forEach(b => b.style.display = 'none');
                document.querySelectorAll('[id^="navButtonFeedbackPage"]').forEach(b => b.style.display = 'none');
            }
        }


        function showPopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) popup.style.display = 'flex';
        }

        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.style.display = 'none';
                const form = popup.querySelector('form');
                if (form) form.reset(); // 팝업 닫을 때 폼 초기화
            }
        }

        function showInfoPopup(message) {
            document.getElementById('infoPopupMessage').innerText = message;
            showPopup('infoPopup');
        }

        async function sendRequest(action, payload = {}) {
            const requestOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                body: JSON.stringify({ action: action, payload: payload, user: loggedInUser ? { ID: loggedInUser.ID, name: loggedInUser.name, isAdmin: loggedInUser.isAdmin } : null }) // 사용자 정보 추가
            };
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, requestOptions);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error', response.status, errorText);
                    return { status: 'error', message: `HTTP 오류: ${response.status}. ${errorText}` };
                }
                const data = await response.json();
                console.log('API Response:', data);
                return data;
            } catch (error) {
                console.error('API Request Error:', error);
                return { status: 'error', message: `네트워크 오류: ${error.message}. URL 또는 배포를 확인하세요.` };
            }
        }

        async function handleLogin() {
            const idInput = document.getElementById('loginId');
            const passwordInput = document.getElementById('loginPassword');
            const id = idInput.value;
            const password = passwordInput.value;

            if (!id || !password) {
                showInfoPopup('ID와 비밀번호를 입력해주세요.');
                return;
            }
            const response = await sendRequest('login', { id: id, password: password });

            if (response.status === 'success' && response.user) {
                loggedInUser = response.user; // 서버로부터 받은 사용자 정보로 업데이트
                console.log('로그인 성공:', loggedInUser);
                updateUserInfo(); // 모든 페이지의 사용자 정보 및 네비 버튼 업데이트

                if (loggedInUser.isAdmin) {
                    showPage('dashboardPage'); // 관리자도 우선 대시보드로
                } else {
                    showPage('dashboardPage');
                }
                idInput.value = '';
                passwordInput.value = '';
            } else {
                showInfoPopup(response.message || '로그인 실패');
            }
        }
        // 엔터키 로그인
        addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });



        function openNewAccountPopup() {
            // 폼 필드 초기화
            document.getElementById('newAccountId').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserAffiliation').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPosition').value = '';
            showPopup('newUserPopup');
        }


        async function handleCreateNewAccount() {
            const id = document.getElementById('newAccountId').value;
            const password = document.getElementById('newUserPassword').value;
            const affiliation = document.getElementById('newUserAffiliation').value;
            const name = document.getElementById('newUserName').value;
            const position = document.getElementById('newUserPosition').value;

            if (!id || !password || !name) {
                showInfoPopup('ID, 비밀번호, 성명은 필수 입력 항목입니다.');
                return;
            }
            const payload = { 
                ID: id, 
                password: password, 
                소속: affiliation, 
                성명: name, 
                직급: position 
            };

            const response = await sendRequest('createUser', payload);
            if (response.status === 'success') {
                showInfoPopup(response.message);
                closePopup('newUserPopup');
                if (loggedInUser && loggedInUser.isAdmin && document.getElementById('adminPage').style.display === 'block') {
                    document.getElementById('infoPopupOkButton').onclick = () => {
                        closePopup('infoPopup');
                        loadAccountData();
                    };
                }
            } else {
                showInfoPopup(response.message);
            }
        }

        function displayDataInTable(data, tableId, headers, editable = false, onRowDoubleClickCallback = null) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = headers.length; // 삭제 컬럼이 없어졌으므로 headers.length로 통일
                cell.innerText = '데이터가 없습니다.';
                cell.style.textAlign = 'center';
                return;
            }
            
            const numericCols = (tableId === 'purchaseTable')
                ? ['단가', '수량', '공급가', '부가세', '합계']
                : (tableId === 'expenseTable')
                    ? ['공급가', '부가세', '합계']
                    : [];

            data.forEach(rowData => {
                const row = tableBody.insertRow();
                if(rowData.rowIndex) row.dataset.rowIndex = rowData.rowIndex;
                if(rowData.ID) row.dataset.userId = rowData.ID; // for accountTable
                if(rowData.EntryID) row.dataset.entryId = rowData.EntryID; // for checkInTable

                headers.forEach((header, colIdx) => {
                    const cell = row.insertCell();
                    let cellValue = rowData[header] === undefined ? '' : rowData[header];

                    if (numericCols.includes(header) && cellValue !== '') {
                        cellValue = formatNumberWithCommas(cellValue);
                        cell.classList.add('numeric');
                    } else if ((header === '세금계산서일자' || header === '일자') && cellValue) {
                        // 날짜 오류 수정: toISOString 대신 yyyy-mm-dd 직접 변환
                        try {
                            const dateObj = new Date(cellValue);
                            if (!isNaN(dateObj.getTime())) {
                                // 타임존 보정 없이 yyyy-mm-dd 추출
                                const yyyy = dateObj.getFullYear();
                                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                                const dd = String(dateObj.getDate()).padStart(2, '0');
                                cellValue = `${yyyy}-${mm}-${dd}`;
                            }
                        } catch (e) { /* no-op */ }
                    }

                    if (header === '품의서링크' || (header === '증빙' && tableId !== 'checkInTable')) { // CheckInTable의 증빙은 링크가 아님
                        if (cellValue) {
                            const link = document.createElement('a');
                            link.href = cellValue;
                            link.innerText = '링크';
                            link.target = '_blank';
                            link.onclick = function(event) { event.stopPropagation(); /* 새 창 열기는 기본 동작 */ };
                            cell.innerHTML = '';
                            cell.appendChild(link);
                        } else {
                            cell.innerText = '-';
                        }
                    } else {
                        cell.innerText = cellValue;
                    }
                });

                if (editable && onRowDoubleClickCallback && tableId !== 'checkInTable') { // 구매, 경비는 수정 팝업
                     row.ondblclick = () => onRowDoubleClickCallback(tableId, rowData);
                } else if (tableId === 'accountTable' && onRowDoubleClickCallback) { // 계정은 계정 수정 팝업
                     row.ondblclick = () => onRowDoubleClickCallback(rowData); // openEditAccountPopup
                     row.onclick = (event) => handleAccountRowClick(event); // 단일 클릭 이벤트
                } else if (tableId === 'checkInTable') { // Check-in 테이블은 더블클릭 시 수정 팝업
                    row.ondblclick = () => openEditCheckInPopup(rowData);
                }
            });
        }
        
        // 구매관리 데이터 로드
        async function loadPurchaseData() {
            if (!loggedInUser) return;
            const response = await sendRequest('getPurchaseData', {
                userName: loggedInUser.name,
                isAdmin: loggedInUser.isAdmin
            });
            if (response.status === 'success') {
                displayDataInTable(response.data, 'purchaseTable', PURCHASE_HEADERS, true, openEditPopup);
            } else {
                showInfoPopup('구매 관리 데이터를 불러오는데 실패했습니다: ' + response.message);
                displayDataInTable([], 'purchaseTable', PURCHASE_HEADERS, true, openEditPopup);
            }
        }

        // 개인경비 데이터 로드
        async function loadExpenseData() {
            if (!loggedInUser) return;
            const response = await sendRequest('getExpenseData', {
                userName: loggedInUser.name,
                isAdmin: loggedInUser.isAdmin
            });
            if (response.status === 'success') {
                displayDataInTable(response.data, 'expenseTable', EXPENSE_HEADERS, true, openEditPopup);
            } else {
                showInfoPopup('개인 경비 데이터를 불러오는데 실패했습니다: ' + response.message);
                displayDataInTable([], 'expenseTable', EXPENSE_HEADERS, true, openEditPopup);
            }
        }
        
        // 계정 정보 로드
        async function loadAccountData() {
            if (!loggedInUser || !loggedInUser.isAdmin) return;
            const response = await sendRequest('getAccounts'); // isAdmin 정보는 sendRequest에서 user 객체에 담아 보냄
            if (response.status === 'success') {
                displayDataInTable(response.accounts, 'accountTable', ACCOUNT_HEADERS, false, openEditAccountPopup);
            } else {
                showInfoPopup('계정 정보를 불러오는데 실패했습니다: ' + response.message);
                displayDataInTable([], 'accountTable', ACCOUNT_HEADERS, false, openEditAccountPopup);
            }
        }

        function setupSumCalculation(popupId, supplyPriceName, vatName, sumName) {
            // popupId는 팝업의 id, form은 popupId 내의 form
            const popup = document.getElementById(popupId);
            if (!popup) return;
            const form = popup.querySelector('form');
            if (!form) return;

            const supplyPriceInput = form.elements[supplyPriceName];
            const vatInput = form.elements[vatName];
            const sumInput = form.elements[sumName];

            function calculateSum() {
                if (!supplyPriceInput || !vatInput || !sumInput) return;
                const supplyPrice = parseFloat(String(supplyPriceInput.value).replace(/,/g, '')) || 0;
                const vat = parseFloat(String(vatInput.value).replace(/,/g, '')) || 0;
                sumInput.value = formatNumberWithCommas(supplyPrice + vat);
            }

            if (supplyPriceInput && vatInput && sumInput) {
                [supplyPriceInput, vatInput].forEach(input => {
                    input.addEventListener('input', calculateSum);
                    input.addEventListener('blur', () => {
                        if (input.value) input.value = formatNumberWithCommas(input.value);
                        calculateSum();
                    });
                });
                if (supplyPriceInput.value || vatInput.value) calculateSum();
            }
        }

        function openNewEntryPopup(type) {
            currentEditingRowIndex = null;
            const popupId = type === 'purchase' ? 'newPurchasePopup' : 'newExpensePopup';
            const popup = document.getElementById(popupId);
            if (!popup) return;
            const form = popup.querySelector('form');
            if (!form) return;
            form.reset();

            // 담당자 자동 입력
            if (loggedInUser && form.elements['담당자']) {
                form.elements['담당자'].value = loggedInUser.name;
                form.elements['담당자'].readOnly = true;
            }

            setupSumCalculation(popupId, '공급가', '부가세', '합계');
            showPopup(popupId);
        }

        function openEditPopup(tableId, rowData) {
            currentEditingRowIndex = rowData.rowIndex;
            let popupId, headers, formPrefix;

            if (tableId === 'purchaseTable') {
                popupId = 'editPurchasePopup';
                headers = PURCHASE_HEADERS;
                formPrefix = 'editPurchase_';
            } else if (tableId === 'expenseTable') {
                popupId = 'editExpensePopup';
                headers = EXPENSE_HEADERS;
                formPrefix = 'editExpense_';
            } else { return; }

            const form = document.querySelector(`#${popupId} form`);
            if (!form) return;
            form.reset();

            headers.forEach(header => {
                const input = form.elements[header]; // name으로 찾기
                if (input) {
                    let value = rowData[header] === undefined ? '' : rowData[header];
                    if ((header === '세금계산서일자' || header === '일자') && value) {
                        try {
                            const dateObj = new Date(value);
                            if (!isNaN(dateObj.getTime())) input.value = dateObj.toISOString().split('T')[0];
                            else input.value = value;
                        } catch (e) { input.value = value; }
                    } else if (['단가', '수량', '공급가', '부가세', '합계'].includes(header)) {
                        input.value = formatNumberWithCommas(value); // 숫자 필드 포맷팅
                    }
                    else {
                        input.value = value;
                    }
                    input.readOnly = (header === '담당자');
                }
            });
             if (tableId === 'purchaseTable') {
                setupSumCalculation(popupId, '공급가', '부가세', '합계');
            } else if (tableId === 'expenseTable') {
                setupSumCalculation(popupId, '공급가', '부가세', '합계');
            }
            showPopup(popupId);
        }
        
        async function handleSaveData(type) {
            const popupId = type === 'purchase' ? (currentEditingRowIndex ? 'editPurchasePopup' : 'newPurchasePopup') : (currentEditingRowIndex ? 'editExpensePopup' : 'newExpensePopup');
            const form = document.querySelector(`#${popupId} form`);
            if (!form) return;

            const dataObject = {};
            const headers = type === 'purchase' ? PURCHASE_HEADERS : EXPENSE_HEADERS;
            let isValid = true; // 간단한 유효성 검사 플래그 (필요시 확장)

            headers.forEach(header => {
                const input = form.elements[header];
                if (input) {
                    // 숫자 필드는 콤마 제거 후 저장
                    if (['단가', '수량', '공급가', '부가세', '합계'].includes(header)) {
                         dataObject[header] = String(input.value).replace(/,/g, '');
                    } else {
                        dataObject[header] = input.value;
                    }
                } else if (header === '담당자' && loggedInUser && !currentEditingRowIndex) { // 신규 작성 시 담당자 자동 입력
                    dataObject[header] = loggedInUser.name;
                }
            });
            
            // 필수 입력 필드 검증 예시 (구매품의명, 물품명 등)
            if (type === 'purchase' && (!dataObject['구매품의명'] || !dataObject['물품명'])) {
                showInfoPopup('구매품의명과 물품명은 필수 입력 항목입니다.');
                isValid = false;
            }
            if (type === 'expense' && (!dataObject['일자'] || !dataObject['적요'])) {
                 showInfoPopup('일자와 적요는 필수 입력 항목입니다.');
                isValid = false;
            }
            if(!isValid) return;


            let response;
            const action = type === 'purchase'
                ? (currentEditingRowIndex ? 'updatePurchase' : 'createPurchase')
                : (currentEditingRowIndex ? 'updateExpense' : 'createExpense');
            
            const payload = currentEditingRowIndex 
                ? { rowIndex: currentEditingRowIndex, data: dataObject } 
                : { data: dataObject };

            response = await sendRequest(action, payload);

            if (response.status === 'success') {
                showInfoPopup(response.message);
                closePopup(popupId);
                const reloadFunction = type === 'purchase' ? loadPurchaseData : loadExpenseData;
                document.getElementById('infoPopupOkButton').onclick = () => {
                    closePopup('infoPopup');
                    reloadFunction();
                };
            } else {
                showInfoPopup(response.message);
            }
        }

        function handleDeleteConfirmation(type) {
            if (!currentEditingRowIndex) {
                showInfoPopup('삭제할 항목이 선택되지 않았습니다.');
                return;
            }
            document.getElementById('confirmDeleteMessage').innerText = '정말 이 항목을 삭제하시겠습니까?';
            showPopup('confirmDeletePopup');
            document.getElementById('confirmDeleteOkButton').onclick = () => handleDeleteData(type);
            document.getElementById('confirmDeleteCancelButton').onclick = () => closePopup('confirmDeletePopup');
        }

        async function handleDeleteData(type) {
            if (!currentEditingRowIndex) {
                showInfoPopup('삭제할 항목이 없습니다.');
                closePopup('confirmDeletePopup');
                return;
            }
            closePopup('confirmDeletePopup');
            const action = type === 'purchase' ? 'deletePurchase' : 'deleteExpense';
            const response = await sendRequest(action, { rowIndex: currentEditingRowIndex });

            if (response.status === 'success') {
                showInfoPopup(response.message);
                const reloadFunction = type === 'purchase' ? loadPurchaseData : loadExpenseData;
                document.getElementById('infoPopupOkButton').onclick = () => {
                    closePopup('infoPopup');
                    reloadFunction();
                };
                const editPopupId = type === 'purchase' ? 'editPurchasePopup' : 'editExpensePopup';
                closePopup(editPopupId); // 수정 팝업도 닫기
            } else {
                showInfoPopup(response.message);
            }
            currentEditingRowIndex = null;
        }

        function handleAccountRowClick(event) {
            document.querySelectorAll('#accountTable tbody tr').forEach(row => row.classList.remove('selected'));
            const clickedRow = event.target.closest('tr');
            if (clickedRow) {
                clickedRow.classList.add('selected');
                selectedAccountId = clickedRow.dataset.userId; // 'data-user-id' 속성 사용
                console.log('Selected Account ID (single click):', selectedAccountId);
            } else {
                selectedAccountId = null;
            }
        }
        
        function openEditAccountPopup(rowData) {
            currentEditingAccountData = rowData;
            currentEditingRowIndex = rowData.rowIndex;

            const form = document.querySelector('#editAccountPopup form');
            form.reset();
            form.elements['ID'].value = rowData.ID || '';
            form.elements['password'].value = '';
            form.elements['password'].placeholder = '새 비밀번호 (변경 시에만 입력)';
            form.elements['소속'].value = rowData.소속 || '';
            form.elements['성명'].value = rowData.성명 || '';
            form.elements['직급'].value = rowData.직급 || '';

            showPopup('editAccountPopup');
        }

        async function handleSaveAccountData() {
            if (!currentEditingAccountData) {
                showInfoPopup('수정할 계정 정보가 없습니다.');
                return;
            }
            const form = document.querySelector('#editAccountPopup form');
            if (!form.elements['성명'].value) {
                showInfoPopup('성명은 필수 입력 항목입니다.');
                return;
            }
            const accountData = {
                소속: form.elements['소속'].value,
                성명: form.elements['성명'].value,
                직급: form.elements['직급'].value
            };

            const newPassword = form.elements['password'].value;
            if (newPassword && newPassword.length > 0) {
                accountData.password = newPassword;
            }
            const payload = {
                userId: currentEditingAccountData.ID,
                accountData: accountData
            };
            const response = await sendRequest('updateAccount', payload);
            if (response.status === 'success') {
                showInfoPopup(response.message);
                closePopup('editAccountPopup');
                document.getElementById('infoPopupOkButton').onclick = () => {
                    closePopup('infoPopup');
                    loadAccountData();
                };
            } else {
                showInfoPopup(response.message);
            }
            currentEditingAccountData = null;
            currentEditingRowIndex = null;
        }

        function handleDeleteConfirmationForAccount() {
            if (!currentEditingAccountData || !currentEditingAccountData.ID) {
                showInfoPopup('삭제할 계정이 선택되지 않았습니다. 목록에서 더블클릭하여 선택해주세요.');
                return;
            }
            if (loggedInUser && loggedInUser.ID === currentEditingAccountData.ID) {
                showInfoPopup('자기 자신의 계정은 삭제할 수 없습니다.');
                return;
            }
            document.getElementById('confirmDeleteMessage').innerText = `ID "${currentEditingAccountData.ID}" 계정을 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`;
            showPopup('confirmDeletePopup');
            document.getElementById('confirmDeleteOkButton').onclick = executeAccountDeletion;
            document.getElementById('confirmDeleteCancelButton').onclick = () => closePopup('confirmDeletePopup');
        }

        async function executeAccountDeletion() {
            if (!currentEditingAccountData || !currentEditingAccountData.ID) { /* ... */ return; }
            if (loggedInUser && loggedInUser.ID === currentEditingAccountData.ID) { /* ... */ return; }
            closePopup('confirmDeletePopup');
            const response = await sendRequest('deleteAccount', { userId: currentEditingAccountData.ID });
            if (response.status === 'success') {
                showInfoPopup(response.message);
                closePopup('editAccountPopup');
                document.getElementById('infoPopupOkButton').onclick = () => {
                    closePopup('infoPopup');
                    loadAccountData();
                };
            } else {
                showInfoPopup(response.message);
            }
            currentEditingAccountData = null;
            currentEditingRowIndex = null;
            selectedAccountId = null; // 선택 해제
        }

        function openUploadFolder(folderUrl) {
            window.open(folderUrl, '_blank', 'width=800,height=600,resizable=yes,scrollbars=yes');
        }
        
        // Check-in Page Functions
        async function loadCheckInData() {
            if (!loggedInUser) return;
            const response = await sendRequest('getCheckInData', {
                // userName: loggedInUser.name, // Apps Script에서 user.name을 사용하므로 payload에 불필요할 수 있음
                // isAdmin: loggedInUser.isAdmin
            });

            if (response.status === 'success' && response.data) {
                const sortedData = response.data.sort((a, b) => new Date(b.일자) - new Date(a.일자));
                displayDataInTable(sortedData, 'checkInTable', CHECKIN_HEADERS); // 재활용
            } else {
                showInfoPopup('Check-in 데이터를 불러오는데 실패했습니다: ' + (response.message || '알 수 없는 오류'));
                displayDataInTable([], 'checkInTable', CHECKIN_HEADERS);
            }
        }

        function clearCheckInInputs(clearAuthor = true) {
            if (clearAuthor) document.getElementById('checkInEntryAuthor').value = '';
            // document.getElementById('checkInEntryDate').valueAsDate = new Date(); // 날짜는 오늘 날짜로 유지
            document.getElementById('checkInEntryCategory').value = '업무';
            document.getElementById('checkInEntryContent').value = '';
            document.getElementById('checkInEntryStatus').value = 'Okay';
        }

        async function handleSaveCheckIn() {
            const author = document.getElementById('checkInEntryAuthor').value;
            const date = document.getElementById('checkInEntryDate').value;
            const category = document.getElementById('checkInEntryCategory').value;
            const content = document.getElementById('checkInEntryContent').value;
            const status = document.getElementById('checkInEntryStatus').value;

            if (!date || !content) {
                showInfoPopup('일자와 내용은 필수 입력 항목입니다.');
                return;
            }
            const checkInData = { 작성자: author, 일자: date, 구분: category, 내용: content, 상태: status, 피드백: '' };
            const response = await sendRequest('createCheckIn', { data: checkInData });

            if (response.status === 'success') {
                showInfoPopup(response.message || 'Check-in이 저장되었습니다.');
                loadCheckInData();
                clearCheckInInputs(false);
                document.getElementById('checkInEntryContent').focus();
            } else {
                showInfoPopup('Check-in 저장 실패: ' + (response.message || '알 수 없는 오류'));
            }
        }
        
        // Dashboard Page Functions
        async function loadDashboardData() {
            if (!loggedInUser) return;
            document.getElementById('dashboardCheckInTableBody').innerHTML = '<tr><td colspan="4">로딩 중...</td></tr>';
            document.getElementById('dashboardPurchaseTableBody').innerHTML = '<tr><td colspan="3">로딩 중...</td></tr>';
            document.getElementById('dashboardExpenseTableBody').innerHTML = '<tr><td colspan="3">로딩 중...</td></tr>';

            const commonPayload = { limit: 10 }; // userName은 서버에서 loggedInUser.name으로 처리

            const checkInResponse = await sendRequest('getCheckInData', commonPayload);
            displayDashboardSummary(checkInResponse, 'dashboardCheckInTableBody', ['일자', '내용', '상태', '피드백']);

            const purchaseResponse = await sendRequest('getPurchaseData', commonPayload);
            displayDashboardSummary(purchaseResponse, 'dashboardPurchaseTableBody', ['세금계산서일자', '물품명', '합계']);
            
            const expenseResponse = await sendRequest('getExpenseData', commonPayload);
            displayDashboardSummary(expenseResponse, 'dashboardExpenseTableBody', ['일자', '적요', '합계']);
        }

        function displayDashboardSummary(response, tableBodyId, headersToDisplay) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';

            if (response.status === 'success' && response.data && response.data.length > 0) {
                 // 최신순 정렬 (날짜 필드가 다를 수 있으므로, 각 타입에 맞게 정렬 필요)
                let sortedData = response.data;
                if (tableBodyId === 'dashboardCheckInTableBody' || tableBodyId === 'dashboardExpenseTableBody') {
                    sortedData = response.data.sort((a, b) => new Date(b.일자) - new Date(a.일자));
                } else if (tableBodyId === 'dashboardPurchaseTableBody') {
                    // 구매는 세금계산서일자 또는 다른 기준의 날짜로 정렬
                    sortedData = response.data.sort((a, b) => {
                        const dateA = new Date(a.세금계산서일자 || a.다른날짜필드 || 0);
                        const dateB = new Date(b.세금계산서일자 || b.다른날짜필드 || 0);
                        return dateB - dateA;
                    });
                }


                sortedData.slice(0, 5).forEach(rowData => {
                    const row = tableBody.insertRow();
                    headersToDisplay.forEach(headerKey => {
                        const cell = row.insertCell();
                        let cellValue = rowData[headerKey] === undefined ? '' : rowData[headerKey];
                        if (headerKey === '합계') {
                        cellValue = formatNumberWithCommas(cellValue);
                        cell.classList.add('numeric');
                        } else if (headerKey === '일자' || headerKey === '세금계산서일자') {
                             cellValue = cellValue ? new Date(cellValue).toISOString().split('T')[0] : '';
                        }
                        cell.innerText = cellValue;
                        if (headerKey === '내용' || headerKey === '구매품의명' || headerKey === '적요') {
                            cell.title = rowData[headerKey];
                        }
                    });
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="${headersToDisplay.length}">${response.message || '최근 기록이 없습니다.'}</td></tr>`;
            }
        }

        window.onload = () => {
            showPage('loginPage');
            // accountTable 클릭 이벤트는 displayDataInTable 내부에서 동적으로 바인딩하도록 변경
        };

        function openCheckInPopup() {
            // 팝업 입력값 초기화
            document.getElementById('popupCheckInEntryAuthor').value = loggedInUser ? loggedInUser.name : '';
            // 날짜 오류 없이 yyyy-mm-dd로 세팅
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            document.getElementById('popupCheckInEntryDate').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('popupCheckInEntryCategory').value = '업무';
            document.getElementById('popupCheckInEntryStatus').value = 'Okay';
            document.getElementById('popupCheckInEntryContent').value = '';
            showPopup('checkInPopup');
        }

        async function handleSaveCheckInFromPopup() {
            const author = document.getElementById('popupCheckInEntryAuthor').value;
            const date = document.getElementById('popupCheckInEntryDate').value;
            const category = document.getElementById('popupCheckInEntryCategory').value;
            const content = document.getElementById('popupCheckInEntryContent').value;
            const status = document.getElementById('popupCheckInEntryStatus').value;

            if (!date || !content) {
                showInfoPopup('일자와 내용은 필수 입력 항목입니다.');
                return;
            }
            const checkInData = { 작성자: author, 일자: date, 구분: category, 내용: content, 상태: status, 피드백: '' };
            const response = await sendRequest('createCheckIn', { data: checkInData });

            if (response.status === 'success') {
                showInfoPopup(response.message || 'Check-in이 저장되었습니다.');
                closePopup('checkInPopup');
                loadCheckInData();
            } else {
                showInfoPopup('Check-in 저장 실패: ' + (response.message || '알 수 없는 오류'));
            }
        }

        function openEditCheckInPopup(rowData) {
            document.getElementById('editCheckInEntryAuthor').value = rowData['작성자'] || '';
            if (rowData['일자']) {
                const dateObj = new Date(rowData['일자']);
                if (!isNaN(dateObj.getTime())) {
                    const yyyy = dateObj.getFullYear();
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    document.getElementById('editCheckInEntryDate').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    document.getElementById('editCheckInEntryDate').value = rowData['일자'];
                }
            } else {
                document.getElementById('editCheckInEntryDate').value = '';
            }
            document.getElementById('editCheckInEntryCategory').value = rowData['구분'] || '업무';
            document.getElementById('editCheckInEntryStatus').value = rowData['상태'] || 'Okay';
            document.getElementById('editCheckInEntryContent').value = rowData['내용'] || '';
            // 수정 대상 rowIndex/EntryID 저장
            window.editingCheckInRowIndex = rowData.rowIndex;
            window.editingCheckInEntryID = rowData.EntryID;
            showPopup('editCheckInPopup');
        }

        async function handleSaveCheckInFromEditPopup() {
            const author = document.getElementById('editCheckInEntryAuthor').value;
            const date = document.getElementById('editCheckInEntryDate').value;
            const category = document.getElementById('editCheckInEntryCategory').value;
            const content = document.getElementById('editCheckInEntryContent').value;
            const status = document.getElementById('editCheckInEntryStatus').value;
            if (!date || !content) {
                showInfoPopup('일자와 내용은 필수 입력 항목입니다.');
                return;
            }
            const checkInData = { 작성자: author, 일자: date, 구분: category, 내용: content, 상태: status, 피드백: '' };
            const payload = { rowIndex: window.editingCheckInRowIndex, data: checkInData };
            const response = await sendRequest('updateCheckIn', payload);
            if (response.status === 'success') {
                showInfoPopup(response.message || 'Check-in이 수정되었습니다.');
                closePopup('editCheckInPopup');
                loadCheckInData();
            } else {
                showInfoPopup('Check-in 수정 실패: ' + (response.message || '알 수 없는 오류'));
            }
        }
    </script>

    <div id="loginPage" class="page">
        <div class="login-box">
            <h2>에이치엘비셀<br> 업무관리시스템 로그인</h2>
            <input type="text" id="loginId" placeholder="ID">
            <input type="password" id="loginPassword" placeholder="Password">
            <button class="login-button" onclick="handleLogin()">로그인</button>
            <button class="new-account-button" onclick="openNewAccountPopup()">신규 계정 생성</button>
        </div>
    </div>

    <div id="dashboardPage" class="page container">
    <div class="header">
        <div>
            <h2>Dashboard</h2>
            <div class="user-info"><span id="dashboard-user-info"></span></div>
        </div>
        <div class="buttons">
            <button class="refresh-button" onclick="loadDashboardData()">새로고침</button>
            <button class="nav-button" onclick="showPage('dashboardPage')">대시보드</button>
            <button class="nav-button" onclick="showPage('checkInPage')">Check-in</button>
            <button class="nav-button" onclick="showPage('purchasePage')">구매관리</button>
            <button class="nav-button" onclick="showPage('expensePage')">개인경비</button>
            <button class="nav-button" id="navButtonAdminPageDashboard" onclick="showPage('adminPage')" style="display:none;">관리자</button>
        </div>
    </div>
    <div class="dashboard-grid">
        <!-- 체크인 보드 (세로) -->
        <div class="dashboard-section">
            <h3>최근 Check-in (최대 5건)</h3>
            <table id="dashboardCheckInTable">
                <thead>
                    <tr>
                        <th>일자</th>
                        <th>내용</th>
                        <th>상태</th>
                        <th>피드백</th>
                    </tr>
                </thead>
                <tbody id="dashboardCheckInTableBody"></tbody>
            </table>
            <div class="dashboard-link">
                <button class="nav-button" onclick="showPage('checkInPage')">Check-in 전체보기 & 작성</button>
            </div>
        </div>
        <!-- 구매/경비 보드 (가로 2분할) -->
        <div class="dashboard-row">
            <div class="dashboard-section">
                <h3>최근 구매관리 (최대 5건)</h3>
                <table id="dashboardPurchaseTable">
                    <thead>
                        <tr>
                            <th>계산서일자</th>
                            <th>물품명</th>
                            <th>합계</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardPurchaseTableBody"></tbody>
                </table>
                <div class="dashboard-link">
                    <button class="nav-button" onclick="showPage('purchasePage')">구매관리 전체보기 & 작성</button>
                </div>
            </div>
            <div class="dashboard-section">
                <h3>최근 개인경비 (최대 5건)</h3>
                <table id="dashboardExpenseTable">
                    <thead>
                        <tr>
                            <th>일자</th>
                            <th>적요</th>
                            <th>합계</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardExpenseTableBody"></tbody>
                </table>
                <div class="dashboard-link">
                    <button class="nav-button" onclick="showPage('expensePage')">개인경비 전체보기 & 작성</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard 데이터 표시 함수 수정
function displayDashboardSummary(response, tableBodyId, headersToDisplay) {
    const tableBody = document.getElementById(tableBodyId);
    tableBody.innerHTML = '';

    if (response.status === 'success' && response.data && response.data.length > 0) {
        // 최신순 정렬
        let sortedData = response.data;
        if (tableBodyId === 'dashboardCheckInTableBody' || tableBodyId === 'dashboardExpenseTableBody') {
            sortedData = response.data.sort((a, b) => new Date(b.일자) - new Date(a.일자));
        } else if (tableBodyId === 'dashboardPurchaseTableBody') {
            sortedData = response.data.sort((a, b) => {
                const dateA = new Date(a.세금계산서일자 || a.다른날짜필드 || 0);
                const dateB = new Date(b.세금계산서일자 || b.다른날짜필드 || 0);
                return dateB - dateA;
            });
        }
        sortedData.slice(0, 5).forEach(rowData => {
            const row = tableBody.insertRow();
            headersToDisplay.forEach((headerKey, idx) => {
                const cell = row.insertCell();
                let cellValue = rowData[headerKey] === undefined ? '' : rowData[headerKey];
                // 체크인: 일자(0), 내용(1), 상태(2), 피드백(3)
                if (tableBodyId === 'dashboardCheckInTableBody') {
                    if (headerKey === '일자') {
                        cellValue = cellValue ? new Date(cellValue).toISOString().split('T')[0] : '';
                    }
                    if (headerKey === '내용' || headerKey === '피드백') {
                        cell.style.whiteSpace = 'normal';
                        cell.style.wordBreak = 'break-all';
                        cell.title = rowData[headerKey];
                    }
                }
                // 구매관리: 합계(콤마)
                if (tableBodyId === 'dashboardPurchaseTableBody' && headerKey === '합계') {
                    cellValue = formatNumberWithCommas(cellValue);
                    cell.classList.add('numeric');
                }
                // 경비관리: 합계(콤마)
                if (tableBodyId === 'dashboardExpenseTableBody' && headerKey === '합계') {
                    cellValue = formatNumberWithCommas(cellValue);
                    cell.classList.add('numeric');
                }
                // 날짜 포맷
                if ((headerKey === '일자' || headerKey === '세금계산서일자') && cellValue) {
                    cellValue = new Date(cellValue).toISOString().split('T')[0];
                }
                cell.innerText = cellValue;
            });
        });
    } else {
        tableBody.innerHTML = `<tr><td colspan="${headersToDisplay.length}">${response.message || '최근 기록이 없습니다.'}</td></tr>`;
    }
}
</script>

<!-- Dashboard 데이터 요청 함수에서 컬럼 순서 맞추기 -->
<script>
async function loadDashboardData() {
    if (!loggedInUser) return;
    document.getElementById('dashboardCheckInTableBody').innerHTML = '<tr><td colspan="4">로딩 중...</td></tr>';
    document.getElementById('dashboardPurchaseTableBody').innerHTML = '<tr><td colspan="3">로딩 중...</td></tr>';
    document.getElementById('dashboardExpenseTableBody').innerHTML = '<tr><td colspan="3">로딩 중...</td></tr>';

    const commonPayload = { limit: 10 };

    // 체크인: 일자, 내용, 상태, 피드백
    const checkInResponse = await sendRequest('getCheckInData', commonPayload);
    displayDashboardSummary(checkInResponse, 'dashboardCheckInTableBody', ['일자', '내용', '상태', '피드백']);

    // 구매관리: 계산서일자, 물품명, 합계
    const purchaseResponse = await sendRequest('getPurchaseData', commonPayload);
    displayDashboardSummary(purchaseResponse, 'dashboardPurchaseTableBody', ['세금계산서일자', '물품명', '합계']);

    // 경비관리: 일자, 적요, 합계
    const expenseResponse = await sendRequest('getExpenseData', commonPayload);
    displayDashboardSummary(expenseResponse, 'dashboardExpenseTableBody', ['일자', '적요', '합계']);
}
</script>

    <div id="purchasePage" class="page container">
        <div class="header">
            <div>
                <h2>구매관리</h2>
                <div class="user-info"><span id="purchase-user-info"></span></div>
            </div>
            <div class="buttons">
                <button class="action-button" onclick="openNewEntryPopup('purchase')">신규 작성</button>
                <button class="refresh-button" onclick="loadPurchaseData()">새로고침</button>
                <button class="nav-button" onclick="showPage('dashboardPage')">대시보드</button>
                <button class="nav-button" onclick="showPage('checkInPage')">Check-in</button>
                <button class="nav-button" onclick="showPage('purchasePage')">구매관리</button>
                <button class="nav-button" onclick="showPage('expensePage')">개인경비</button>
            </div>
        </div>
        <div class="data-section">
            <table id="purchaseTable">
                <thead><tr><th>담당자</th><th>구매구분</th><th>프로젝트</th><th>국책과제여부</th><th>구매품의번호</th><th>구매품의명</th><th>품의서링크</th><th>구매처</th><th>물품명</th><th>단가</th><th>수량</th><th>공급가</th><th>부가세</th><th>합계</th><th>세금계산서일자</th><th>비고</th><th>증빙</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="expensePage" class="page container">
        <div class="header">
            <div>
                <h2>개인경비관리</h2>
                <div class="user-info"><span id="expense-user-info"></span></div>
            </div>
            <div class="buttons">
                <button class="action-button" onclick="openNewEntryPopup('expense')">신규 작성</button>
                <button class="refresh-button" onclick="loadExpenseData()">새로고침</button>
                <button class="nav-button" onclick="showPage('dashboardPage')">대시보드</button>
                <button class="nav-button" onclick="showPage('checkInPage')">Check-in</button>
                <button class="nav-button" onclick="showPage('purchasePage')">구매관리</button>
                <button class="nav-button" onclick="showPage('expensePage')">개인경비</button>
            </div>
        </div>
        <div class="data-section">
            <table id="expenseTable">
                <thead><tr><th>담당자</th><th>일자</th><th>비목</th><th>사용처</th><th>적요</th><th>공급가</th><th>부가세</th><th>합계</th><th>비고</th><th>증빙</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="checkInPage" class="page container">
        <div class="header">
            <div>
                <h2>Check-in!!</h2>
                <div class="user-info"><span id="checkin-user-info"></span></div>
            </div>
            <div class="buttons">
                <button class="action-button" onclick="openCheckInPopup()">신규 작성</button>
                <button class="refresh-button" onclick="loadCheckInData()">새로고침</button>
                <button class="nav-button" onclick="showPage('dashboardPage')">대시보드</button>
                <button class="nav-button" onclick="showPage('checkInPage')">Check-in</button>
                <button class="nav-button" onclick="showPage('purchasePage')">구매관리</button>
                <button class="nav-button" onclick="showPage('expensePage')">개인경비</button>
            </div>
        </div>
        <!-- 체크인 입력 폼 영역 삭제됨 -->
        <div class="data-section">
            <table id="checkInTable">
                <thead><tr><th>작성자</th><th>일자</th><th>구분</th><th>내용</th><th>상태</th><th>피드백</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="checkInPopup" class="popup-overlay">
    <div class="popup-content" style="max-width:700px;">
        <h3>새로운 Check-in 작성</h3>
        <form id="checkInPopupForm">
            <div class="form-group"><label for="popupCheckInEntryAuthor">작성자:</label><input type="text" id="popupCheckInEntryAuthor" name="작성자" readonly></div>
            <div class="form-group"><label for="popupCheckInEntryDate">일자:</label><input type="date" id="popupCheckInEntryDate" name="일자"></div>
            <div class="form-group"><label for="popupCheckInEntryCategory">구분:</label>
                <select id="popupCheckInEntryCategory" name="구분">
                    <option value="업무">업무</option>
                    <option value="요청">요청</option>
                    <option value="일상">일상</option>
                    <option value="기분">기분</option>
                    <option value="기타">기타</option>
                </select>
            </div>
            <div class="form-group"><label for="popupCheckInEntryStatus">상태:</label>
                <select id="popupCheckInEntryStatus" name="상태">
                    <option value="Great">Great</option>
                    <option value="Good">Good</option>
                    <option value="Okay" selected>Okay</option>
                    <option value="No Good">No Good</option>
                    <option value="Poor">Poor</option>
                </select>
            </div>
            <div class="form-group full-width">
                <label for="popupCheckInEntryContent">내용:</label>
                <textarea id="popupCheckInEntryContent" name="내용" rows="4" style="min-height:90px;"></textarea>
            </div>
            <div class="button-group">
                <button type="button" class="save-button" onclick="handleSaveCheckInFromPopup()">SAVE</button>
                <button type="button" class="cancel-button" onclick="closePopup('checkInPopup')">CANCEL</button>
            </div>
        </form>
    </div>
</div>
<style>
    #checkInPopup .popup-content {
        max-width: 700px;
        width: 90%;
    }
    #checkInPopup form {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    #checkInPopup .form-group.full-width {
        grid-column: 1 / -1;
    }
    #checkInPopup textarea {
        min-height: 90px;
        resize: vertical;
    }
    #checkInPopup .button-group {
        grid-column: 1 / -1;
        text-align: right;
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }
</style>

    <div id="editCheckInPopup" class="popup-overlay">
        <div class="popup-content" style="max-width:700px;">
            <h3>Check-in 수정/삭제</h3>
            <form id="editCheckInPopupForm">
                <div class="form-group"><label for="editCheckInEntryAuthor">작성자:</label><input type="text" id="editCheckInEntryAuthor" name="작성자" readonly></div>
                <div class="form-group"><label for="editCheckInEntryDate">일자:</label><input type="date" id="editCheckInEntryDate" name="일자"></div>
                <div class="form-group"><label for="editCheckInEntryCategory">구분:</label>
                    <select id="editCheckInEntryCategory" name="구분">
                        <option value="업무">업무</option>
                        <option value="요청">요청</option>
                        <option value="일상">일상</option>
                        <option value="기분">기분</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group"><label for="editCheckInEntryStatus">상태:</label>
                    <select id="editCheckInEntryStatus" name="상태">
                        <option value="Great">Great</option>
                        <option value="Good">Good</option>
                        <option value="Okay" selected>Okay</option>
                        <option value="No Good">No Good</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="editCheckInEntryContent">내용:</label>
                    <textarea id="editCheckInEntryContent" name="내용" rows="4" style="min-height:90px;"></textarea>
                </div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveCheckInFromEditPopup()">SAVE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('editCheckInPopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="adminPage" class="page container">
        <div class="header">
            <div>
                <h2>관리자 페이지</h2>
                <div class="user-info"><span id="admin-user-info"></span></div>
            </div>
            <div class="buttons">
                <button class="action-button admin-create-button" onclick="openNewAccountPopup()">계정 생성</button>
                <button class="refresh-button" onclick="loadAccountData()">계정 새로고침</button>
                <button class="nav-button" onclick="showPage('dashboardPage')">대시보드</button>
                <button class="nav-button" onclick="showPage('checkInPage')">Check-in</button>
                <button class="nav-button" onclick="showPage('purchasePage')">구매관리</button>
                <button class="nav-button" onclick="showPage('expensePage')">개인경비</button>
                <button class="nav-button" id="navButtonFeedbackPageAdmin" onclick="showPage('feedbackPage')" style="display:none;">피드백관리</button>
            </div>
        </div>
        <div class="data-section">
            <table id="accountTable">
                <thead><tr><th>ID</th><th>password</th><th>소속</th><th>성명</th><th>직급</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="newUserPopup" class="popup-overlay">
        <div class="popup-content">
            <h3>신규계정 생성</h3>
            <form>
                <div class="form-group"><label for="newAccountId">ID:</label><input type="text" id="newAccountId" name="ID" required></div>
                <div class="form-group"><label for="newUserPassword">Password:</label><input type="password" id="newUserPassword" name="password" required></div>
                <div class="form-group"><label for="newUserAffiliation">소속:</label><input type="text" id="newUserAffiliation" name="소속"></div>
                <div class="form-group"><label for="newUserName">성명:</label><input type="text" id="newUserName" name="성명" required></div>
                <div class="form-group"><label for="newUserPosition">직급:</label><input type="text" id="newUserPosition" name="직급"></div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleCreateNewAccount()">SAVE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('newUserPopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newPurchasePopup" class="popup-overlay">
        <div class="popup-content">
            <h3>신규 구매항목 작성</h3>
            <form id="newPurchasePopupForm">
                <div class="form-group"><label for="newPurchase_담당자">담당자:</label><input type="text" id="newPurchase_담당자" name="담당자" readonly></div>
                <div class="form-group">
                    <label for="newPurchase_구매구분">구매구분:</label>
                    <select name="구매구분">
                        <option value="재료">재료</option><option value="장비">장비</option><option value="비품">비품</option><option value="소모품">소모품</option><option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newPurchase_프로젝트">프로젝트:</label>
                    <select name="프로젝트">
                        <option value="세포외기질">세포외기질</option><option value="지혈제">지혈제</option><option value="인공간">인공간</option><option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newPurchase_국책과제여부">국책과제여부:</label>
                    <select name="국책과제여부"><option value="일반">일반</option><option value="국책과제">국책과제</option></select>
                </div>
                <div class="form-group"><label for="newPurchase_구매품의번호">구매품의번호:</label><input type="text" name="구매품의번호"></div>
                <div class="form-group"><label for="newPurchase_구매품의명">구매품의명:</label><input type="text" name="구매품의명"></div>
                <div class="form-group"><label for="newPurchase_품의서링크">품의서링크:</label><input type="text" name="품의서링크"></div>
                <div class="form-group"><label for="newPurchase_구매처">구매처:</label><input type="text" name="구매처"></div>
                <div class="form-group"><label for="newPurchase_물품명">물품명:</label><input type="text" name="물품명"></div>
                <div class="form-group"><label for="newPurchase_단가">단가:</label><input type="text" name="단가"></div>
                <div class="form-group"><label for="newPurchase_수량">수량:</label><input type="text" name="수량"></div>
                <div class="form-group"><label for="newPurchase_공급가">공급가:</label><input type="text" name="공급가"></div>
                <div class="form-group"><label for="newPurchase_부가세">부가세:</label><input type="text" name="부가세"></div>
                <div class="form-group"><label for="newPurchase_합계">합계:</label><input type="text" name="합계" readonly></div>
                <div class="form-group"><label for="newPurchase_세금계산서일자">세금계산서일자:</label><input type="date" name="세금계산서일자"></div>
                <div class="form-group"><label for="newPurchase_비고">비고:</label><input type="text" name="비고"></div>
                <div class="form-group">
                    <label for="newPurchase_증빙">증빙:</label>
                    <div class="upload-button-group">
                        <input type="text" name="증빙">
                        <button type="button" onclick="openUploadFolder('https://drive.google.com/drive/folders/1kOGLuw3IMCot0VtjCM5AP0uGKDSW8dm9?usp=sharing')">업로드</button>
                    </div>
                </div>
                <div class="popup-instructions">
                    <p>구매증빙 파일명: 일자_거래처명_담당자명 (예: 250509_한국은행_정래호)</p>
                    <p>증빙 업로드 후 해당파일 우클릭 &gt; 공유 &gt; 링크복사 후 링크를 증빙입력란에 입력바랍니다.</p>
                </div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveData('purchase')">SAVE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('newPurchasePopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editPurchasePopup" class="popup-overlay">
        <div class="popup-content">
            <h3>구매항목 수정/삭제</h3>
            <form id="editPurchasePopupForm">
                <div class="form-group"><label>담당자:</label><input type="text" name="담당자" readonly></div>
                <div class="form-group"><label>구매구분:</label>
                    <select name="구매구분">
                        <option value="재료">재료</option><option value="장비">장비</option><option value="비품">비품</option><option value="소모품">소모품</option><option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group"><label>프로젝트:</label>
                    <select name="프로젝트">
                        <option value="세포외기질">세포외기질</option><option value="지혈제">지혈제</option><option value="인공간">인공간</option><option value="기타">기타</option>
                    </select>
                </div>
                 <div class="form-group"><label>국책과제여부:</label>
                    <select name="국책과제여부"><option value="일반">일반</option><option value="국책과제">국책과제</option></select>
                </div>
                <div class="form-group"><label>구매품의번호:</label><input type="text" name="구매품의번호"></div>
                <div class="form-group"><label>구매품의명:</label><input type="text" name="구매품의명"></div>
                <div class="form-group"><label>품의서링크:</label><input type="text" name="품의서링크"></div>
                <div class="form-group"><label>구매처:</label><input type="text" name="구매처"></div>
                <div class="form-group"><label>물품명:</label><input type="text" name="물품명"></div>
                <div class="form-group"><label>단가:</label><input type="text" name="단가"></div>
                <div class="form-group"><label>수량:</label><input type="text" name="수량"></div>
                <div class="form-group"><label>공급가:</label><input type="text" name="공급가"></div>
                <div class="form-group"><label>부가세:</label><input type="text" name="부가세"></div>
                <div class="form-group"><label>합계:</label><input type="text" name="합계" readonly></div>
                <div class="form-group"><label>세금계산서일자:</label><input type="date" name="세금계산서일자"></div>
                <div class="form-group"><label>비고:</label><input type="text" name="비고"></div>
                <div class="form-group">
                    <label>증빙:</label>
                    <div class="upload-button-group">
                        <input type="text" name="증빙">
                        <button type="button" onclick="openUploadFolder('https://drive.google.com/drive/folders/1kOGLuw3IMCot0VtjCM5AP0uGKDSW8dm9?usp=sharing')">업로드</button>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveData('purchase')">SAVE</button>
                    <button type="button" class="delete-button" onclick="handleDeleteConfirmation('purchase')">DELETE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('editPurchasePopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newExpensePopup" class="popup-overlay">
        <div class="popup-content">
            <h3>신규 개인경비 작성</h3>
            <form id="newExpensePopupForm">
                <div class="form-group"><label for="newExpense_담당자">담당자:</label><input type="text" id="newExpense_담당자" name="담당자" readonly></div>
                <div class="form-group"><label for="newExpense_일자">일자:</label><input type="date" id="newExpense_일자" name="일자"></div>
                <div class="form-group">
                    <label for="newExpense_비목">비목:</label>
                    <select id="newExpense_비목" name="비목">
                        <option value="여비교통비">여비교통비</option><option value="복리후생비">복리후생비</option><option value="소모품비">소모품비</option><option value="지급수수료">지급수수료</option><option value="통신비">통신비</option><option value="운반비">운반비</option><option value="접대비">접대비</option><option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group"><label for="newExpense_사용처">사용처:</label><input type="text" id="newExpense_사용처" name="사용처"></div>
                <div class="form-group"><label for="newExpense_적요">적요:</label><input type="text" id="newExpense_적요" name="적요"></div>
                <div class="form-group"><label for="newExpense_공급가">공급가:</label><input type="text" id="newExpense_공급가" name="공급가"></div>
                <div class="form-group"><label for="newExpense_부가세">부가세:</label><input type="text" id="newExpense_부가세" name="부가세"></div>
                <div class="form-group"><label for="newExpense_합계">합계:</label><input type="text" id="newExpense_합계" name="합계" readonly></div>
                <div class="form-group"><label for="newExpense_비고">비고:</label><input type="text" id="newExpense_비고" name="비고"></div>
                <div class="form-group">
                    <label for="newExpense_증빙">증빙:</label>
                    <div class="upload-button-group">
                        <input type="text" id="newExpense_증빙" name="증빙">
                        <button type="button" onclick="openUploadFolder('https://drive.google.com/drive/folders/1VJhUETiHdxF7wRifLrVljeIhP2lVnHVJ?usp=sharing')">업로드</button>
                    </div>
                </div>
                <div class="popup-instructions">
                    <p>경비증빙 파일명: 일자_해당월 개인경비_담당자명 (예: 250509_2025년05월 개인경비_정래호)</p>
                    <p>증빙 업로드 후 해당파일 우클릭 &gt; 공유 &gt; 링크복사 후 링크를 증빙입력란에 입력바랍니다.</p>
                </div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveData('expense')">SAVE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('newExpensePopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editExpensePopup" class="popup-overlay">
        <div class="popup-content">
            <h3>개인경비 수정/삭제</h3>
            <form id="editExpensePopupForm">
                <div class="form-group"><label>담당자:</label><input type="text" name="담당자" readonly></div>
                <div class="form-group"><label>일자:</label><input type="date" name="일자"></div>
                <div class="form-group"><label>비목:</label>
                     <select name="비목">
                        <option value="여비교통비">여비교통비</option><option value="복리후생비">복리후생비</option><option value="소모품비">소모품비</option><option value="지급수수료">지급수수료</option><option value="통신비">통신비</option><option value="운반비">운반비</option><option value="접대비">접대비</option><option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group"><label>사용처:</label><input type="text" name="사용처"></div>
                <div class="form-group"><label>적요:</label><input type="text" name="적요"></div>
                <div class="form-group"><label>공급가:</label><input type="text" name="공급가"></div>
                <div class="form-group"><label>부가세:</label><input type="text" name="부가세"></div>
                <div class="form-group"><label>합계:</label><input type="text" name="합계" readonly></div>
                <div class="form-group"><label>비고:</label><input type="text" name="비고"></div>
                <div class="form-group">
                    <label>증빙:</label>
                    <div class="upload-button-group">
                        <input type="text" name="증빙">
                        <button type="button" onclick="openUploadFolder('https://drive.google.com/drive/folders/1VJhUETiHdxF7wRifLrVljeIhP2lVnHVJ?usp=sharing')">업로드</button>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveData('expense')">SAVE</button>
                    <button type="button" class="delete-button" onclick="handleDeleteConfirmation('expense')">DELETE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('editExpensePopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editAccountPopup" class="popup-overlay">
        <div class="popup-content">
            <h3>계정정보 수정/삭제</h3>
            <form>
                <div class="form-group"><label for="editAccount_ID">ID:</label><input type="text" id="editAccount_ID" name="ID" readonly></div>
                <div class="form-group"><label for="editAccount_password">Password:</label><input type="password" id="editAccount_password" name="password" placeholder="새 비밀번호 (변경 시에만 입력)"></div>
                <div class="form-group"><label for="editAccount_소속">소속:</label><input type="text" id="editAccount_소속" name="소속"></div>
                <div class="form-group"><label for="editAccount_성명">성명:</label><input type="text" id="editAccount_성명" name="성명"></div>
                <div class="form-group"><label for="editAccount_직급">직급:</label><input type="text" id="editAccount_직급" name="직급"></div>
                <div class="button-group">
                    <button type="button" class="save-button" onclick="handleSaveAccountData()">SAVE</button>
                    <button type="button" class="delete-button" onclick="handleDeleteConfirmationForAccount()">DELETE</button>
                    <button type="button" class="cancel-button" onclick="closePopup('editAccountPopup')">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeletePopup" class="popup-overlay">
        <div class="popup-content" style="max-width: 450px;"> <h3>삭제 확인</h3>
            <p id="confirmDeleteMessage" style="margin-top: 10px; margin-bottom: 20px; line-height: 1.6;"></p>
            <div class="button-group">
                <button type="button" id="confirmDeleteOkButton" class="delete-button">확인</button>
                <button type="button" id="confirmDeleteCancelButton" class="cancel-button">취소</button>
            </div>
        </div>
    </div>

    <div id="infoPopup" class="popup-overlay">
        <div class="popup-content" style="max-width: 450px;">
            <h3>알림</h3>
            <p id="infoPopupMessage" style="margin-top: 10px; margin-bottom: 20px; line-height: 1.6;"></p>
            <div class="button-group">
                <button type="button" id="infoPopupOkButton" class="save-button" onclick="closePopup('infoPopup')">확인</button>
            </div>
        </div>
    </div>

</body>
</html>
